name: ZTM CSV-driven Migration

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'true for dry-run (no real replication). false to perform replication.'
        required: true
        default: 'true'

jobs:
  migrate:
    runs-on: windows-latest

    env:
      AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      MIG_INPUT_CSV:       'migration_input.csv'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show PowerShell / Az info
        shell: pwsh
        run: |
          $PSVersionTable
          Get-ExecutionPolicy

      - name: Install Az PowerShell
        shell: pwsh
        run: |
          Install-Module Az -Scope CurrentUser -Force -AllowClobber
          Import-Module Az.Accounts,Az.Resources,Az.Network,Az.Migrate
          Get-Module Az* | Format-Table Name,Version

      - name: Run migration (CSV-driven)
        shell: pwsh
        env:
          MIG_MODE: ${{ github.event.inputs.DRY_RUN == 'true' && 'DryRun' || 'Replicate' }}
        run: |
          cd ${{ github.workspace }}

          Write-Host "========== Starting CSV-driven migration =========="
          Write-Host "MIG_INPUT_CSV: $env:MIG_INPUT_CSV"
          Write-Host "MIG_MODE     : $env:MIG_MODE"

          .\login-and-trigger.ps1 -UseServicePrincipal -InputCsv $env:MIG_INPUT_CSV -Mode $env:MIG_MODE

      # Upload the JSON outputs even if a step failed
      - name: Upload discovery & mapping outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ztm-outputs-${{ github.run_id }}
          path: |
            ${{ github.workspace }}\out\discovery-output.json
            ${{ github.workspace }}\out\mapping-output.json
          retention-days: 14
        # Upload the full diagnostics folder (REST/CLI raw dumps per VM)
      - name: Upload raw diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ztm-raw-${{ github.run_id }}
          path: ${{ github.workspace }}\out\raw