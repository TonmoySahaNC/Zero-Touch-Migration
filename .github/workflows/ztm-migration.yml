name: ZTM CSV-driven Migration

on:
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'true for dry-run (no real create). false to perform replication.'
        required: true
        default: 'true'

jobs:
  migrate:
    runs-on: windows-latest
    env:
      AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      USE_SERVICE_PRINCIPAL: "true"
      MIG_NONINTERACTIVE:    "true"
      # Path to CSV in repo (change if stored elsewhere)
      MIG_INPUT_CSV: "./migration_input.csv"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Az PowerShell
        shell: pwsh
        run: |
          Install-Module Az -Scope CurrentUser -Force -AllowClobber
          Import-Module Az.Accounts,Az.Resources,Az.Compute,Az.Network,Az.Storage

      - name: Run migration (CSV-driven)
        shell: pwsh
        env:
          MIG_MODE: ${{ github.event.inputs.DRY_RUN == 'true' && 'DryRun' || 'Replicate' }}
        run: |
          cd ${{ github.workspace }}
          # run login-and-trigger using service principal, supply CSV path and Mode
          .\0-touch\login-and-trigger.ps1 -UseServicePrincipal -InputCsv $env:MIG_INPUT_CSV -Mode $env:MIG_MODE
